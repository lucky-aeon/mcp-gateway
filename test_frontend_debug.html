<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>MCP Debug Test</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
            }
            .section {
                border: 1px solid #ddd;
                margin: 20px 0;
                padding: 20px;
                border-radius: 8px;
            }
            .section h2 {
                margin-top: 0;
            }
            button {
                padding: 10px 20px;
                margin: 5px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                background-color: #007bff;
                color: white;
            }
            button:disabled {
                background-color: #ccc;
                cursor: not-allowed;
            }
            textarea,
            input {
                width: 100%;
                margin: 10px 0;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 4px;
            }
            #messages {
                height: 300px;
                overflow-y: auto;
                border: 1px solid #ddd;
                padding: 10px;
                background-color: #f8f9fa;
                white-space: pre-wrap;
            }
            .status {
                padding: 5px 10px;
                border-radius: 4px;
                margin: 5px 0;
            }
            .connected {
                background-color: #d4edda;
                color: #155724;
            }
            .disconnected {
                background-color: #f8d7da;
                color: #721c24;
            }
        </style>
    </head>
    <body>
        <h1>MCP Debug Test Page</h1>

        <div class="section">
            <h2>Service Selection</h2>
            <input
                type="text"
                id="serviceName"
                placeholder="Enter service name (e.g., test-service)"
                value="test-service"
            />
            <input
                type="text"
                id="workspaceId"
                placeholder="Enter workspace ID (e.g., default)"
                value="default"
            />
            <p>
                <strong>Current Service:</strong>
                <span id="currentService">test-service</span>
            </p>
            <p>
                <strong>Current Workspace:</strong>
                <span id="currentWorkspace">default</span>
            </p>
            <p>
                <strong>SSE URL:</strong>
                <span id="sseUrl"
                    >/{serviceName}/sse?workspace={workspaceId}</span
                >
            </p>
            <p>
                <strong>Message URL:</strong>
                <span id="messageUrl"
                    >/{serviceName}/message (with X-Workspace-Id header)</span
                >
            </p>
        </div>

        <div class="section">
            <h2>SSE Connection Test</h2>
            <div id="sseStatus" class="status disconnected">Disconnected</div>
            <button id="connectBtn" onclick="connectSSE()">Connect SSE</button>
            <button id="disconnectBtn" onclick="disconnectSSE()" disabled>
                Disconnect SSE
            </button>
            <button onclick="clearMessages()">Clear Messages</button>

            <h3>Received Messages:</h3>
            <div id="messages"></div>
        </div>

        <div class="section">
            <h2>Message Sending Test</h2>
            <h3>Predefined Messages:</h3>
            <button onclick="sendPing()">Send Ping</button>
            <button onclick="sendInitialize()">Send Initialize</button>
            <button onclick="sendListTools()">List Tools</button>
            <button onclick="sendListResources()">List Resources</button>

            <h3>Custom Message:</h3>
            <textarea
                id="customMessage"
                rows="8"
                placeholder="Enter JSON-RPC message..."
            >
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "ping",
  "params": {}
}</textarea
            >
            <button onclick="sendCustomMessage()">Send Custom Message</button>

            <h3>Response:</h3>
            <textarea id="response" rows="8" readonly></textarea>
        </div>

        <script>
            let eventSource = null;
            let currentServiceName = "test-service";
            let currentWorkspaceId = "default";

            // Update service URLs when service name or workspace changes
            document
                .getElementById("serviceName")
                .addEventListener("input", function (e) {
                    currentServiceName = e.target.value || "test-service";
                    updateServiceDisplay();
                });

            document
                .getElementById("workspaceId")
                .addEventListener("input", function (e) {
                    currentWorkspaceId = e.target.value || "default";
                    updateServiceDisplay();
                });

            function updateServiceDisplay() {
                document.getElementById("currentService").textContent =
                    currentServiceName;
                document.getElementById("currentWorkspace").textContent =
                    currentWorkspaceId;
                document.getElementById("sseUrl").textContent =
                    `/${currentServiceName}/sse?workspace=${currentWorkspaceId}`;
                document.getElementById("messageUrl").textContent =
                    `/${currentServiceName}/message (with X-Workspace-Id: ${currentWorkspaceId})`;
            }

            function connectSSE() {
                if (eventSource) {
                    eventSource.close();
                }

                const sseUrl = `/${currentServiceName}/sse?workspace=${encodeURIComponent(currentWorkspaceId)}`;
                console.log("Connecting to SSE:", sseUrl);

                eventSource = new EventSource(sseUrl);

                eventSource.onopen = function () {
                    console.log("SSE connection opened");
                    document.getElementById("sseStatus").className =
                        "status connected";
                    document.getElementById("sseStatus").textContent =
                        "Connected";
                    document.getElementById("connectBtn").disabled = true;
                    document.getElementById("disconnectBtn").disabled = false;
                };

                eventSource.onmessage = function (event) {
                    console.log("SSE message received:", event.data);
                    const messages = document.getElementById("messages");
                    const timestamp = new Date().toLocaleTimeString();
                    messages.textContent += `[${timestamp}] ${event.data}\n`;
                    messages.scrollTop = messages.scrollHeight;
                };

                eventSource.onerror = function (error) {
                    console.error("SSE error:", error);
                    document.getElementById("sseStatus").className =
                        "status disconnected";
                    document.getElementById("sseStatus").textContent =
                        "Connection Error";
                    document.getElementById("connectBtn").disabled = false;
                    document.getElementById("disconnectBtn").disabled = true;
                };
            }

            function disconnectSSE() {
                if (eventSource) {
                    eventSource.close();
                    eventSource = null;
                }
                document.getElementById("sseStatus").className =
                    "status disconnected";
                document.getElementById("sseStatus").textContent =
                    "Disconnected";
                document.getElementById("connectBtn").disabled = false;
                document.getElementById("disconnectBtn").disabled = true;
            }

            function clearMessages() {
                document.getElementById("messages").textContent = "";
            }

            async function sendMessage(message) {
                const messageUrl = `/${currentServiceName}/message`;
                console.log("Sending message to:", messageUrl, message);

                try {
                    const response = await fetch(messageUrl, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            Authorization: "Bearer 123456",
                            "X-Workspace-Id": currentWorkspaceId,
                        },
                        body: JSON.stringify(message),
                    });

                    if (!response.ok) {
                        throw new Error(
                            `HTTP error! status: ${response.status}`,
                        );
                    }

                    const responseData = await response.text();
                    document.getElementById("response").value = responseData;
                    console.log("Response received:", responseData);

                    return responseData;
                } catch (error) {
                    console.error("Error sending message:", error);
                    document.getElementById("response").value =
                        `Error: ${error.message}`;
                    throw error;
                }
            }

            function sendPing() {
                sendMessage({
                    jsonrpc: "2.0",
                    id: 1,
                    method: "ping",
                    params: {},
                });
            }

            function sendInitialize() {
                sendMessage({
                    jsonrpc: "2.0",
                    id: 2,
                    method: "initialize",
                    params: {
                        protocolVersion: "2024-11-05",
                        capabilities: {},
                        clientInfo: {
                            name: "MCP Gateway Debug",
                            version: "1.0.0",
                        },
                    },
                });
            }

            function sendListTools() {
                sendMessage({
                    jsonrpc: "2.0",
                    id: 3,
                    method: "tools/list",
                    params: {},
                });
            }

            function sendListResources() {
                sendMessage({
                    jsonrpc: "2.0",
                    id: 4,
                    method: "resources/list",
                    params: {},
                });
            }

            function sendCustomMessage() {
                try {
                    const messageText =
                        document.getElementById("customMessage").value;
                    const message = JSON.parse(messageText);
                    sendMessage(message);
                } catch (error) {
                    document.getElementById("response").value =
                        `Error parsing JSON: ${error.message}`;
                }
            }

            // Initialize display
            updateServiceDisplay();
        </script>
    </body>
</html>
